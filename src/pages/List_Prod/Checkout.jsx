import { useState, useEffect, useMemo } from "react";
import { useNavigate } from "react-router-dom"; 
import { TopBar } from "../Home/components/TopBar";
import { Footer } from "../Home/components/Footer";
import "./checkout.css";
import qrImage from "../../../public/vite.svg";

// Claves de localStorage
const LOCAL_STORAGE_CART_KEY = "cart"; 
const LOCAL_STORAGE_USER_KEY = "nombre";

// ====================================================================
// FUNCIONES AUXILIARES (Se mantienen igual)
// ====================================================================

// Funci√≥n para obtener datos de localStorage (sin try/catch expl√≠cito)
const getFromLocalStorage = (key, defaultValue) => {
    const stored = localStorage.getItem(key);
    return stored ? JSON.parse(stored) : defaultValue;
};

// Funci√≥n para guardar datos en localStorage (Mantiene try/catch donde es cr√≠tico)
const setLocalStorage = (key, value) => {
    try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
    } catch (error) {
        console.error(`Error al guardar ${key} en localStorage:`, error);
        return false;
    }
};

export const Checkout = () => {
    // Inicializar useNavigate
    const navigate = useNavigate();
    
    // 1. Cargar datos iniciales del carrito y usuario desde localStorage
    const [cartItems, setCartItems] = useState(() => {
        // Solo incluimos productos que NO est√©n "guardados para despu√©s" (Comportamiento original)
        const fullCart = getFromLocalStorage(LOCAL_STORAGE_CART_KEY, []);
        return fullCart.filter(item => !item.guardado);
    });

    const initialUserName = localStorage.getItem(LOCAL_STORAGE_USER_KEY) || "";

    // Estados de formulario
    const [nombre, setNombre] = useState(initialUserName); 
    const [direccion, setDireccion] = useState("");
    const [ciudad, setCiudad] = useState("");
    const [metodoPago, setMetodoPago] = useState("qr");
    const [tarjeta, setTarjeta] = useState("");
    const [fechaExp, setFechaExp] = useState("");
    const [cvv, setCvv] = useState("");
    const [metodoEnvio, setMetodoEnvio] = useState("estandar");

    // 2. Calcular totales usando useMemo para optimizaci√≥n
    const { subtotal, costoEnvio, totalFinal } = useMemo(() => {
        const subtotalCalc = cartItems.reduce((sum, item) => sum + item.precio * item.cantidad, 0);
        const envioCalc = metodoEnvio === "express" ? 20 : 10;
        const totalFinalCalc = subtotalCalc + envioCalc;
        
        return {
            subtotal: subtotalCalc.toFixed(2),
            costoEnvio: envioCalc.toFixed(2),
            totalFinal: totalFinalCalc.toFixed(2),
        };
    }, [cartItems, metodoEnvio]);


    // 3. L√≥gica para confirmar la orden, vaciar el carrito y redirigir
    const handleConfirmarOrden = () => {
        // --- VALIDACIONES ---
        if (!nombre || !direccion || !ciudad) {
            alert("Por favor completa los datos de env√≠o.");
            return;
        }
        if (metodoPago === "tarjeta" && (!tarjeta || !fechaExp || !cvv)) {
            alert("Completa todos los campos de la tarjeta.");
            return;
        }
        if (cartItems.length === 0) {
            alert("Tu carrito est√° vac√≠o.");
            navigate('/catalogo'); 
            return;
        }
        
        // --- CREACI√ìN DE LA ORDEN (Solo para mostrar el resumen, no se guarda) ---
        const nuevaOrden = {
            id: Date.now(),
            cliente: nombre,
            total: parseFloat(totalFinal),
        };

        // --- VACIAR CARRITO COMPLETAMENTE ---
        // üö® CAMBIO: Se llama a setLocalStorage con un array vac√≠o []
        const cartCleared = setLocalStorage(LOCAL_STORAGE_CART_KEY, []); 
        
        // --- RESPUESTA Y REDIRECCI√ìN ---
        if (cartCleared) {
            setCartItems([]); // Limpiar el estado local
            alert(`Orden #${nuevaOrden.id} completada con √©xito. Total: S/ ${totalFinal}. Volviendo al inicio.`);
            
            // Redireccionar a la p√°gina principal
            navigate("/"); 

        } else {
             // Este error ya fue manejado y logeado por setLocalStorage
            alert("Hubo un error al procesar tu orden debido a un problema de almacenamiento. Intenta nuevamente.");
        }
    };

    return (
        <>
            <TopBar />
            <div className="order-container">
                <h1>Checkout - Completa tu orden</h1>

                {/* Lista de productos */}
                <div className="order-section">
                    <h2>Productos en tu carrito ({cartItems.length})</h2>
                    {cartItems.length > 0 ? (
                        cartItems.map((item) => (
                            <div key={item.id} className="order-item">
                                <p>{item.nombre} x {item.cantidad}</p>
                                <p>S/ {(item.precio * item.cantidad).toFixed(2)}</p>
                            </div>
                        ))
                    ) : (
                        <p>No hay productos activos en el carrito. Por favor, ve al cat√°logo.</p>
                    )}
                </div>

                {/* Datos de env√≠o */}
                <div className="order-section">
                    <h2>Direcci√≥n de env√≠o</h2>
                    <input
                        type="text"
                        placeholder="Nombre completo"
                        value={nombre}
                        onChange={(e) => setNombre(e.target.value)}
                    />
                    <input
                        type="text"
                        placeholder="Direcci√≥n"
                        value={direccion}
                        onChange={(e) => setDireccion(e.target.value)}
                    />
                    <input
                        type="text"
                        placeholder="Ciudad / Pa√≠s"
                        value={ciudad}
                        onChange={(e) => setCiudad(e.target.value)}
                    />
                </div>

                {/* M√©todo de pago */}
                <div className="order-section">
                    <h2>M√©todo de pago</h2>
                    <select onChange={(e) => setMetodoPago(e.target.value)} value={metodoPago}>
                        <option value="qr">C√≥digo QR</option>
                        <option value="tarjeta">Tarjeta de cr√©dito</option>
                    </select>

                    {metodoPago === "qr" ? (
                        <div className="qr-container">
                            <p>Escanea este c√≥digo para completar el pago:</p>
                            <img src={qrImage} alt="C√≥digo QR" className="qr-img" />
                        </div>
                    ) : (
                        <div className="tarjeta-form">
                            <input
                                type="text"
                                placeholder="N√∫mero de tarjeta"
                                value={tarjeta}
                                onChange={(e) => setTarjeta(e.target.value)}
                                maxLength="16"
                            />
                            <input
                                type="text"
                                placeholder="Fecha de expiraci√≥n (MM/AA)"
                                value={fechaExp}
                                onChange={(e) => setFechaExp(e.target.value)}
                                maxLength="5"
                            />
                            <input
                                type="text"
                                placeholder="CVV"
                                value={cvv}
                                onChange={(e) => setCvv(e.target.value)}
                                maxLength="4"
                            />
                        </div>
                    )}
                </div>

                {/* M√©todo de env√≠o */}
                <div className="order-section">
                    <h2>M√©todo de env√≠o</h2>
                    <select onChange={(e) => setMetodoEnvio(e.target.value)} value={metodoEnvio}>
                        <option value="estandar">Est√°ndar (S/10.00)</option>
                        <option value="express">Express (S/20.00)</option>
                    </select>
                </div>

                {/* Resumen final */}
                <div className="order-summary">
                    <h2>Resumen de la orden</h2>
                    <p>Subtotal: S/ {subtotal}</p>
                    <p>Env√≠o: S/ {costoEnvio}</p>
                    <h3>Total final: S/ {totalFinal}</h3>
                </div>

                <button 
                    className="btn-confirmar primary-btn"
                    onClick={handleConfirmarOrden} 
                    disabled={cartItems.length === 0}
                >
                    Completar orden
                </button>
            </div>
            <Footer />
        </>
    );
};

export default Checkout;